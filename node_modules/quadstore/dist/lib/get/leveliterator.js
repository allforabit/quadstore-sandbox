"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LevelIterator = void 0;
const asynciterator_1 = require("asynciterator");
class LevelIterator extends asynciterator_1.BufferedIterator {
    constructor(levelIterator, mapper) {
        super();
        this.mapFn = mapper;
        this.level = levelIterator;
    }
    _read(qty, done) {
        const loop = (remaining) => {
            if (remaining === 0) {
                done();
                return;
            }
            this.level.next((err, key, value) => {
                this.onNextValue(err, key, value, remaining, loop, done);
            });
        };
        loop(qty);
    }
    onNextValue(err, key, value, remaining, loop, done) {
        if (err) {
            done(err);
            return;
        }
        if (key === undefined && value === undefined) {
            this.close();
            done();
            return;
        }
        this._push(this.mapFn(key, value));
        loop(remaining - 1);
    }
    ;
    _end(destroy) {
        if (!this.ended) {
            super._end(destroy);
            if (!destroy) {
                this.level.end((endErr) => {
                    if (endErr) {
                        this.emit('error', endErr);
                    }
                });
            }
        }
    }
    _destroy(cause, cb) {
        super._destroy(cause, (destroyErr) => {
            if (destroyErr) {
                cb(destroyErr);
                return;
            }
            this.level.end(cb);
        });
    }
}
exports.LevelIterator = LevelIterator;
//# sourceMappingURL=leveliterator.js.map